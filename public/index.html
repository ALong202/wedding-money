<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Excel Search</title>
    <!-- Bootstrap CSS CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        max-width: 900px;
        margin: 50px auto;
      }
      table th,
      table td {
        vertical-align: middle;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="text-center mb-4">Tìm kiếm tiền cưới</h1>

      <div class="input-group mb-3">
        <input
          id="search"
          type="text"
          class="form-control"
          placeholder="Nhập tên..."
        />
        <button class="btn btn-primary" id="searchBtn">Tìm</button>
      </div>

      <div id="count" class="mb-2 fw-bold"></div>

      <div class="table-responsive">
        <table class="table table-bordered table-striped" id="resultTable">
          <thead class="table-dark">
            <tr>
              <th>Tên</th>
              <th>Số tiền</th>
            </tr>
          </thead>
          <tbody>
            <!-- Kết quả hiển thị ở đây -->
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // Hàm bỏ dấu tiếng Việt
      function normalizeString(str) {
        return str
          .normalize("NFD") // tách dấu
          .replace(/[\u0300-\u036f]/g, "") // bỏ dấu
          .toLowerCase();
      }

      async function doSearch() {
        const qInput = document.getElementById("search").value.trim();
        if (!qInput) return;

        const q = normalizeString(qInput);

        const res = await fetch(`/search?q=${encodeURIComponent(qInput)}`);
        const data = await res.json();

        // Lọc lại client-side để hỗ trợ tìm không dấu
        const filtered = data.data.filter((item) => {
          const name = normalizeString(item.name);
          return name.includes(q);
        });

        // Hiển thị số lượng
        document.getElementById(
          "count"
        ).textContent = `Tìm thấy ${filtered.length} kết quả cho "${qInput}"`;

        // Tạo bảng kết quả
        const tbody = document.querySelector("#resultTable tbody");
        tbody.innerHTML = "";

        filtered.forEach((item) => {
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.innerHTML = highlight(item.name, qInput);
          tr.appendChild(tdName);

          const tdAmount = document.createElement("td");
          tdAmount.textContent = item.amount;
          tr.appendChild(tdAmount);

          tbody.appendChild(tr);
        });
      }

      // Highlight từ khóa
      function highlight(text, keyword) {
        const normalizedText = normalizeString(text);
        const normalizedKeyword = normalizeString(keyword);
        if (!normalizedKeyword) return text;

        let result = "";
        let i = 0;
        while (i < text.length) {
          const slice = text.slice(i, i + normalizedKeyword.length);
          if (normalizeString(slice) === normalizedKeyword) {
            result += `<mark>${slice}</mark>`;
            i += normalizedKeyword.length;
          } else {
            result += text[i];
            i++;
          }
        }
        return result;
      }

      // Kích hoạt nút tìm khi nhấn Enter
      document
        .getElementById("search")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            doSearch();
          }
        });

      document.getElementById("searchBtn").addEventListener("click", doSearch);
    </script>
  </body>
</html>
