<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Wedding money</title>
    <!-- Bootstrap CSS CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        max-width: 900px;
        margin: 20px auto;
      }
      input.form-control, button.btn {
        font-size: 16px;
        padding: 12px;
      }
      table th, table td {
        vertical-align: middle;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="text-center mb-4">Tìm kiếm tiền cưới</h1>

      <!-- Responsive row input + button -->
      <div class="row g-2 mb-3">
        <div class="col-8">
          <input
            id="search"
            type="text"
            class="form-control"
            placeholder="Nhập tên..."
          />
        </div>
        <div class="col-4">
          <button class="btn btn-primary w-100" id="searchBtn">Tìm</button>
        </div>
      </div>

      <div id="count" class="mb-2 fw-bold"></div>

      <div class="table-responsive">
        <table class="table table-bordered table-striped" id="resultTable">
          <thead class="table-dark">
            <tr>
              <th>Tên</th>
              <th>Số tiền</th>
            </tr>
          </thead>
          <tbody>
            <!-- Kết quả hiển thị ở đây -->
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // Hàm bỏ dấu tiếng Việt
      function normalizeString(str) {
        return String(str || "")
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase()
          .trim();
      }

      async function doSearch() {
        const qInput = document.getElementById("search").value.trim();
        if (!qInput) return;

        const res = await fetch(`/search?q=${encodeURIComponent(qInput)}`);
        const data = await res.json();

        // Server đã tìm không dấu → chỉ cần highlight client-side
        const filtered = data.data;

        // Hiển thị số lượng
        document.getElementById(
          "count"
        ).textContent = `Tìm thấy ${filtered.length} kết quả cho "${qInput}"`;

        // Tạo bảng kết quả
        const tbody = document.querySelector("#resultTable tbody");
        tbody.innerHTML = "";

        filtered.forEach((item) => {
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.innerHTML = highlight(item.name, qInput);
          tr.appendChild(tdName);

          const tdAmount = document.createElement("td");
          tdAmount.textContent = item.amount;
          tr.appendChild(tdAmount);

          tbody.appendChild(tr);
        });
      }

      // Highlight từ khóa
      function highlight(text, keyword) {
        const normalizedText = normalizeString(text);
        const normalizedKeyword = normalizeString(keyword);
        if (!normalizedKeyword) return text;

        let result = "";
        let i = 0;
        while (i < text.length) {
          const slice = text.slice(i, i + normalizedKeyword.length);
          if (normalizeString(slice) === normalizedKeyword) {
            result += `<mark>${slice}</mark>`;
            i += normalizedKeyword.length;
          } else {
            result += text[i];
            i++;
          }
        }
        return result;
      }

      // Kích hoạt nút tìm khi nhấn Enter
      document
        .getElementById("search")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            doSearch();
          }
        });

      document.getElementById("searchBtn").addEventListener("click", doSearch);
    </script>
  </body>
</html>
